{% extends 'base.html' %}
{% load static %}

{% block title %}Instructor Dashboard - NeuraQuiz{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="dashboard-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h1 class="display-6 fw-bold mb-2">Welcome back, {{ user.username }}! ðŸ‘‹</h1>
                        <p class="text-muted mb-0">Manage your quizzes and track student performance</p>
                    </div>
                    <!-- <a href="{% url 'quiz:create_quiz' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus-circle me-2"></i>Create New Quiz
                    </a> -->
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-6 col-lg-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number">{{ total_quizzes }}</h3>
                    <p class="stats-label">Total Quizzes</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #10B981 0%, #34D399 100%);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number">{{ published_quizzes }}</h3>
                    <p class="stats-label">Published</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #06B6D4 0%, #22D3EE 100%);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number">{{ recent_attempts.count }}</h3>
                    <p class="stats-label">Attempts</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number">{{ ai_generated_quizzes }}</h3>
                    <p class="stats-label">AI Generated</p>
                </div>
            </div>
        </div>
    </div>

    <!-- My Quizzes Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="section-header d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <h2 class="fw-bold mb-0">
                        <i class="fas fa-folder-open me-2 text-primary"></i>My Quizzes
                    </h2>
                    {% if user_profile.quiz_access_code %}
                    <div class="access-code-badge">
                        <span class="badge bg-info text-dark fs-6 py-2 px-3">
                            <i class="fas fa-key me-2"></i>Access Code: <strong>{{ user_profile.quiz_access_code }}</strong>
                        </span>
                    </div>
                    {% endif %}
                </div>
                <a href="{% url 'quiz:create_quiz' %}" class="btn btn-primary w-100 w-md-auto create-quiz-btn">
                    <i class="fas fa-plus me-2"></i>Create Quiz
                </a>
            </div>
            
            {% if quizzes %}
                <div class="row g-4">
                    {% for quiz in quizzes %}
                    <div class="col-md-6 col-lg-4">
                        <div class="quiz-card">
                            <div class="quiz-header">
                                <h5 class="quiz-title">{{ quiz.title }}</h5>
                                <div class="quiz-badges">
                                    {% if quiz.is_ai_generated %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-robot me-1"></i>AI
                                        </span>
                                    {% endif %}
                                    {% if quiz.difficulty|lower == 'easy' %}
                                        <span class="badge badge-difficulty-easy">{{ quiz.difficulty|title }}</span>
                                    {% elif quiz.difficulty|lower == 'medium' %}
                                        <span class="badge badge-difficulty-medium">{{ quiz.difficulty|title }}</span>
                                    {% elif quiz.difficulty|lower == 'hard' %}
                                        <span class="badge badge-difficulty-hard">{{ quiz.difficulty|title }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ quiz.difficulty|title }}</span>
                                    {% endif %}
                                    {% if quiz.is_published %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-eye me-1"></i>Published
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-pen me-1"></i>Draft
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="quiz-body">
                                <p class="quiz-description">{{ quiz.description|truncatewords:15 }}</p>
                                
                                <div class="quiz-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-tag"></i>
                                        <span>{{ quiz.topic }}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>{{ quiz.time_limit }} min</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-question-circle"></i>
                                        <span>{{ quiz.total_questions }} questions</span>
                                    </div>
                                </div>
                                
                                <div class="quiz-actions">
                                    <a href="{% url 'quiz:edit_quiz' quiz.id %}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </a>
                                    {% if quiz.is_published %}
                                        <a href="{% url 'quiz:take_quiz' quiz.id %}" class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-play me-1"></i>Preview
                                        </a>
                                    {% endif %}
                                    <button class="btn btn-outline-danger btn-sm" onclick="showDeleteQuizModal('{{ quiz.id }}', '{{ quiz.title }}')">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-folder-open" style="font-size: 5rem;"></i>
                    <h4 class="mt-4 mb-2">No quizzes yet</h4>
                    <p class="text-muted mb-4">Create your first quiz to get started with NeuraQuiz</p>
                    <!-- <a href="{% url 'quiz:create_quiz' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus-circle me-2"></i>Create Your First Quiz
                    </a> -->
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Attempts Section -->
    {% if recent_attempts %}
    <div class="row">
        <div class="col-12">
            <div class="section-header mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-history me-2 text-primary"></i>Recent Quiz Attempts
                </h2>
            </div>
            
            <div class="card border-0 shadow-md">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Quiz</th>
                                <th>Score</th>
                                <th>Time Taken</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attempt in recent_attempts %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle me-2">
                                            {{ attempt.user.username|first|upper }}
                                        </div>
                                        <span class="fw-semibold">{{ attempt.user.username }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-medium">{{ attempt.quiz.title }}</span>
                                </td>
                                <td>
                                    <span class="badge {% if attempt.score >= 80 %}bg-success{% elif attempt.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ attempt.score|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>{{ attempt.time_taken|default:"N/A" }}s</td>
                                <td>{{ attempt.started_at|date:"M d, Y" }}</td>
                                <td>
                                    {% if attempt.is_completed %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Completed
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i>In Progress
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
    <!-- Delete Quiz Modal -->
    <div class="modal fade" id="deleteQuizModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow-strong">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-trash-alt me-2 text-danger"></i>Delete Quiz
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to delete "<span id="delete-quiz-title"></span>"? This action cannot be undone.</p>
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        All questions and student attempts for this quiz will be permanently deleted.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteQuizForm" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">
                            <i class="fas fa-trash-alt me-2"></i>Delete Quiz
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
function showDeleteQuizModal(quizId, quizTitle) {
    // Set the quiz title in the modal
    document.getElementById('delete-quiz-title').textContent = quizTitle;
    
    // Set up the form action
    const form = document.getElementById('deleteQuizForm');
    form.action = `/delete-quiz/${quizId}/`;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('deleteQuizModal'));
    modal.show();
    
    // Reset the button state
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Delete Quiz';
}

// Handle the delete form submission
document.getElementById('deleteQuizForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Deleting...';
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.dashboard-header {
    animation: fadeInUp 0.6s ease-out;
}

.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
}

.section-header {
    animation: fadeInUp 0.6s ease-out 0.1s backwards;
}

.stats-card {
    animation: fadeInUp 0.6s ease-out backwards;
}

.stats-card:nth-child(1) { animation-delay: 0.1s; }
.stats-card:nth-child(2) { animation-delay: 0.2s; }
.stats-card:nth-child(3) { animation-delay: 0.3s; }
.stats-card:nth-child(4) { animation-delay: 0.4s; }

.quiz-card {
    animation: fadeInUp 0.6s ease-out backwards;
}

.access-code-badge {
    animation: fadeInUp 0.6s ease-out 0.2s backwards;
}

.access-code-badge .badge {
    font-size: 1rem;
    letter-spacing: 0.1em;
    box-shadow: 0 2px 8px rgba(13, 202, 240, 0.3);
}

/* Make Create Quiz button compact horizontally but taller vertically on desktop only */
@media (min-width: 768px) {
    .create-quiz-btn {
        padding: 0.625rem 1.25rem !important;
        font-size: 0.875rem;
        white-space: nowrap;
        min-width: auto !important;
        width: auto !important;
        max-width: fit-content !important;
        flex-shrink: 0 !important;
        flex-grow: 0 !important;
        align-self: flex-start;
    }
}

/* Ensure button is full width on mobile */
@media (max-width: 767px) {
    .create-quiz-btn {
        width: 100% !important;
        padding: 0.75rem 1.5rem;
    }
}
</style>
{% endblock %}