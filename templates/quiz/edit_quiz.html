{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Quiz - {{ quiz.title }}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Quiz Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="quiz-edit-header card border-0 shadow-md">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                        <div class="flex-grow-1">
                            <h1 class="display-6 fw-bold mb-2">{{ quiz.title }}</h1>
                            <div class="d-flex flex-wrap gap-3 text-muted">
                                <span><i class="fas fa-tag me-1"></i>{{ quiz.topic }}</span>
                                <span><i class="fas fa-signal me-1"></i>{{ quiz.difficulty|title }}</span>
                                <span><i class="fas fa-clock me-1"></i>{{ quiz.time_limit }} min</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <!-- <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#aiModal">
                                <i class="fas fa-robot me-2"></i>Generate with AI
                            </button> -->
                            <form method="post" action="{% url 'quiz:publish_quiz' quiz.id %}" class="d-inline">
                                {% csrf_token %}
                                <button class="btn btn-success" type="submit">
                                    <i class="fas fa-eye me-2"></i>Publish Quiz
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number" data-stat="questions-count">{{ questions.count }}</h3>
                    <p class="stats-label">Questions</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #10B981 0%, #34D399 100%);">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number" data-stat="ai-generated-count">{{ ai_generated_count }}</h3>
                    <p class="stats-label">AI Generated</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #06B6D4 0%, #22D3EE 100%);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stats-content">
                    <h3 class="stats-number">{{ quiz.time_limit }}</h3>
                    <p class="stats-label">Minutes</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stats-card">
                {% if quiz.is_published %}
                <div class="stats-icon" style="background: linear-gradient(135deg, #10B981 0%, #34D399 100%);">
                    <i class="fas fa-eye"></i>
                </div>
                {% else %}
                <div class="stats-icon" style="background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);">
                    <i class="fas fa-pen"></i>
                </div>
                {% endif %}
                <div class="stats-content">
                    <h3 class="stats-number" style="font-size: 1.25rem;">{{ quiz.is_published|yesno:"Published,Draft" }}</h3>
                    <p class="stats-label">Status</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions List -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-md">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h3 class="mb-0 fw-bold">
                        <i class="fas fa-list-ol me-2"></i>Questions
                    </h3>
                    <div class="d-flex gap-2 flex-wrap w-100 w-md-auto">
                        <button class="btn btn-outline-primary flex-fill flex-md-fill-auto" data-bs-toggle="modal" data-bs-target="#aiModal">
                            <i class="fas fa-robot me-2"></i>Generate with AI
                        </button>
                        <a class="btn btn-primary flex-fill flex-md-fill-auto" href="{% url 'quiz:add_question' quiz.id %}">
                            <i class="fas fa-plus me-2"></i>Add Question
                        </a>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <div id="questions-list">
                        {% if questions %}
                            {% for question in questions %}
                            <div class="question-item card border mb-3" data-question-id="{{ question.id }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="flex-grow-1">
                                            <h5 class="fw-bold mb-2">
                                                <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
                                                Question {{ forloop.counter }}
                                            </h5>
                                            <p class="mb-0">{{ question.text }}</p>
                                        </div>
                                        <div class="d-flex gap-2 align-items-center flex-nowrap" style="white-space: nowrap;">
                                            <span class="badge" style="background: linear-gradient(135deg, #06B6D4 0%, #22D3EE 100%);">
                                                {{ question.question_type|title }}
                                            </span>
                                            {% if question.ai_generated %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-robot me-1"></i>AI
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    {% if question.question_type == 'mcq_single' or question.question_type == 'mcq_multiple' %}
                                        {% if question.choices.exists %}
                                            <div class="choices-list mb-3">
                                                <h6 class="text-muted mb-2"><i class="fas fa-list-ul me-2"></i>Choices:</h6>
                                                <ul class="list-unstyled mb-0">
                                                    {% for choice in question.choices.all %}
                                                    <li class="d-flex align-items-center mb-2">
                                                        <input type="checkbox" class="form-check-input me-2" 
                                                               {% if choice.is_correct %}checked{% endif %} disabled>
                                                        <span class="{% if choice.is_correct %}fw-bold text-success{% endif %}">
                                                            {{ choice.choice_text }}
                                                        </span>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}
                                    {% elif question.question_type == 'true_false' %}
                                        <div class="answer-display mb-3">
                                            <h6 class="text-muted mb-2"><i class="fas fa-check-circle me-2"></i>Correct Answer:</h6>
                                            <p class="mb-0">
                                                <span class="text-success fw-bold fs-6">{{ question.correct_answer|title }}</span>
                                            </p>
                                        </div>
                                    {% elif question.question_type == 'short_answer' %}
                                        <div class="answer-display mb-3">
                                            <h6 class="text-muted mb-2"><i class="fas fa-keyboard me-2"></i>Correct Answer:</h6>
                                            <p class="mb-0">
                                                <span class="text-success fw-bold fs-6">{{ question.correct_answer }}</span>
                                            </p>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="question-actions d-flex gap-2">
                                        <a class="btn btn-outline-primary btn-sm" href="{% url 'quiz:edit_question' question.id %}">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </a>
                                        <button class="btn btn-outline-danger btn-sm" type="button" onclick="showDeleteQuestionModal('{{ question.id }}', '{{ forloop.counter }}')">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state text-center py-5">
                                <i class="fas fa-question-circle" style="font-size: 5rem; color: var(--gray-300);"></i>
                                <h4 class="mt-4 mb-2">No questions yet</h4>
                                <p class="text-muted mb-4">Add questions manually or generate them with AI</p>
                                <!-- <div class="d-flex gap-2 justify-content-center flex-wrap">
                                    <a class="btn btn-primary" href="{% url 'quiz:add_question' quiz.id %}">
                                        <i class="fas fa-plus me-2"></i>Add Question
                                    </a>
                                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#aiModal">
                                        <i class="fas fa-robot me-2"></i>Generate with AI
                                    </button>
                                </div> -->
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Generation Modal -->
<div class="modal fade" id="aiModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-strong">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-robot me-2"></i>Generate Questions with AI
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4">
                <form id="ai-generation-form" method="post">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="ai-topic" class="form-label">Topic</label>
                            <input type="text" class="form-control" id="ai-topic" value="{{ quiz.topic }}" required>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="ai-num-questions" class="form-label">Number of Questions</label>
                            <div class="position-relative">
                                <select class="form-select ai-num-questions-select" id="ai-num-questions" required style="cursor:pointer;">
                                    <option value="5">5 Questions</option>
                                    <option value="10" selected>10 Questions</option>
                                    <option value="15">15 Questions</option>
                                    <option value="20">20 Questions</option>
                                </select>
                                <span class="fa fa-chevron-down position-absolute end-0 top-50 translate-middle-y pe-3 text-muted pointer-events-none"></span>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="ai-difficulty" class="form-label">Difficulty</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="ai-difficulty" value="{{ quiz.difficulty|title }}" readonly style="background-color: #f8f9fa; cursor: default;">
                            </div>
                            <small class="text-muted">Set during quiz creation</small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label for="ai-instructions" class="form-label">Additional Instructions (Optional)</label>
                        <textarea class="form-control" id="ai-instructions" rows="3" 
                            placeholder="Any specific requirements or focus areas..."></textarea>
                    </div>
                </form>
                {% if not ai_enabled %}
                <div class="alert alert-warning mt-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    AI service is not configured. To enable question generation, set <code>GEMINI_API_KEY</code> in your environment and restart the server.
                </div>
                {% endif %}

                <div id="ai-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted fw-semibold">AI is generating questions...</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generate-ai-questions" data-quiz-id="{{ quiz.id }}" data-ai-enabled="{{ ai_enabled|yesno:'true,false' }}" data-quiz-difficulty="{{ quiz.difficulty }}" {% if not ai_enabled %}disabled{% endif %}>
                    <i class="fas fa-robot me-2"></i>Generate Questions
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Question Confirmation Modal -->
<div class="modal fade" id="deleteQuestionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-strong">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-trash-alt me-2 text-danger"></i>Delete Question
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Are you sure you want to delete <strong>Question <span id="delete-question-number"></span></strong>? This action cannot be undone.</p>
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    This will remove the question and its choices from the quiz permanently.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteQuestionForm" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" id="confirmDeleteQuestionBtn">
                        <i class="fas fa-trash-alt me-2"></i>Delete Question
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alert-container"></div>
{% endblock %}

{% block extra_js %}
<script>
function addQuestion() {
    window.location.href = "{% url 'quiz:add_question' quiz.id %}";
}

function editQuestion(questionId) {
    alert('Edit question functionality will be implemented');
}

// Initialize AI generator
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.aiGenerator !== 'undefined') {
        window.aiGenerator.init();
    }
});

function showDeleteQuestionModal(questionId, questionNumber) {
    // Populate modal content
    document.getElementById('delete-question-number').textContent = questionNumber;
    const form = document.getElementById('deleteQuestionForm');
    form.action = '/delete-question/' + questionId + '/';

    // Reset confirm button state
    const btn = document.getElementById('confirmDeleteQuestionBtn');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-trash-alt me-2"></i>Delete Question';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteQuestionModal'));
    modal.show();

    // Handle submit loading state
    form.addEventListener('submit', function(e) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Deleting...';
    }, { once: true });
}
</script>
{% endblock %}